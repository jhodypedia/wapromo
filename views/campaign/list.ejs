<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <h4 class="mb-0"><i class="fa fa-bullhorn text-primary me-2"></i>Campaigns</h4>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#campaignModal">
    <i class="fa fa-plus me-2"></i>Campaign Baru
  </button>
</div>

<div class="card shadow-sm">
  <div class="card-body table-responsive">
    <table id="campaignTable" class="table table-hover align-middle w-100">
      <thead class="table-light">
        <tr>
          <th style="width:40px">#</th>
          <th>Nama</th>
          <th>Template</th>
          <th>Status</th>
          <th style="width:150px">Aksi</th>
        </tr>
      </thead>
      <tbody id="campaignTableBody">
        <!-- AJAX isi -->
      </tbody>
    </table>
  </div>
</div>

<!-- Modal Create Campaign -->
<div class="modal fade" id="campaignModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form id="campaignForm">
        <div class="modal-header border-0">
          <h5 class="modal-title"><i class="fa fa-plus text-primary me-2"></i>Campaign Baru</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Nama Campaign</label>
            <input type="text" id="campaignName" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Template</label>
            <select id="templateId" class="form-select" required>
              <option value="">-- Pilih Template --</option>
              <% templates.forEach(t => { %>
                <option value="<%= t.id %>"><%= t.title %></option>
              <% }) %>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Session</label>
            <select id="sessionId" class="form-select" required>
              <option value="">-- Pilih Session --</option>
              <% sessions.forEach(s => { %>
                <option value="<%= s.id %>"><%= s.label || s.sessionId %></option>
              <% }) %>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Target</label>
            <textarea id="numbers" rows="4" class="form-control" placeholder="628xxx (satu per baris)"></textarea>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Speed Min (ms)</label>
              <input type="number" id="speedMinMs" class="form-control" value="5000" />
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Speed Max (ms)</label>
              <input type="number" id="speedMaxMs" class="form-control" value="15000" />
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="submit" class="btn btn-primary">Simpan</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Detail Campaign -->
<div class="modal fade" id="campaignDetailModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title"><i class="fa fa-eye text-info me-2"></i>Detail Campaign</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="campaignDetailBody">
        <div class="text-muted">Loading...</div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const socket = io();

  let table = $('#campaignTable').DataTable({
    responsive: true,
    pageLength: 5,
    lengthMenu: [5, 10, 25, 50],
    language: {
      search: "Cari:",
      lengthMenu: "Tampilkan _MENU_ data",
      info: "Menampilkan _START_ - _END_ dari _TOTAL_ data",
      paginate: { previous: "‹", next: "›" },
      zeroRecords: "Tidak ada data ditemukan"
    }
  });

  async function loadCampaigns() {
    const res = await fetch("/campaigns/list");
    const data = await res.json();
    table.clear();

    data.forEach((c,i)=>{
      const statusBadge = `<span class="badge rounded-pill bg-${
        c.status==="done"?"success":c.status==="running"?"warning":c.status==="stopped"?"danger":"secondary"
      } px-3 py-2">${c.status}</span>`;

      const actions = `
        ${c.status==="idle"
          ? `<button class="btn btn-sm btn-success run-campaign" data-id="${c.id}"><i class="fa fa-play"></i></button>`
          : (c.status==="running"
            ? `<button class="btn btn-sm btn-warning stop-campaign" data-id="${c.id}"><i class="fa fa-stop"></i></button>`:"")
        }
        <button class="btn btn-sm btn-info text-white detail-campaign" data-id="${c.id}"><i class="fa fa-eye"></i></button>
        <button class="btn btn-sm btn-danger delete-campaign" data-id="${c.id}"><i class="fa fa-trash"></i></button>
      `;

      table.row.add([
        i+1,
        `<span class="fw-semibold">${c.name}</span>`,
        c.template?c.template.title:"-",
        statusBadge,
        `<div class="d-flex gap-1">${actions}</div>`
      ]);
    });

    table.draw();
    bindActions();
  }

  function bindActions(){
    // Run
    $('#campaignTable').off('click','.run-campaign').on('click','.run-campaign',async function(){
      const id=$(this).data('id');
      const res=await fetch(`/campaigns/${id}/run`,{method:"POST"});
      const json=await res.json();
      if(json.success){Swal.fire("Berhasil","Campaign dijalankan","success");loadCampaigns();}
      else Swal.fire("Error",json.error,"error");
    });

    // Stop
    $('#campaignTable').off('click','.stop-campaign').on('click','.stop-campaign',async function(){
      const id=$(this).data('id');
      const ok=await Swal.fire({title:"Stop Campaign?",icon:"warning",showCancelButton:true});
      if(!ok.isConfirmed)return;
      const res=await fetch(`/campaigns/${id}/stop`,{method:"POST"});
      const json=await res.json();
      if(json.success){Swal.fire("Berhasil","Campaign dihentikan","success");loadCampaigns();}
      else Swal.fire("Error",json.error,"error");
    });

    // Delete
    $('#campaignTable').off('click','.delete-campaign').on('click','.delete-campaign',async function(){
      const id=$(this).data('id');
      const ok=await Swal.fire({title:"Hapus Campaign?",icon:"warning",showCancelButton:true});
      if(!ok.isConfirmed)return;
      await fetch(`/campaigns/${id}`,{method:"DELETE"});
      loadCampaigns();
    });

    // Detail
    $('#campaignTable').off('click','.detail-campaign').on('click','.detail-campaign',async function(){
      const id=$(this).data('id');
      const body=document.getElementById("campaignDetailBody");
      body.innerHTML="<div class='text-muted'>Loading...</div>";
      new bootstrap.Modal(document.getElementById("campaignDetailModal")).show();

      const res=await fetch(`/campaigns/${id}/detail`);
      const json=await res.json();
      if(json.success){
        const cp=json.campaign;
        body.innerHTML=`
          <h6 class="fw-bold">${cp.name}</h6>
          <p><b>Status:</b> ${cp.status}</p>
          <hr>
          <h6 class="fw-bold">Target</h6>
          <ul class="list-group small">
            ${cp.targets.map(t=>`
              <li class="list-group-item d-flex justify-content-between align-items-center" id="target-${t.id}">
                <span>${t.number}</span>
                <span>
                  <div class="progress d-inline-block" style="width:80px;height:8px;display:none">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width:100%"></div>
                  </div>
                  <span class="badge bg-${t.status==="success"?"success":t.status==="error"?"danger":t.status==="valid"?"info":"secondary"}">${t.status}</span>
                </span>
              </li>
            `).join("")}
          </ul>`;
      }
    });
  }

  // socket real-time progress
  socket.on("campaign_progress",({targetId,status})=>{
    const li=document.getElementById(`target-${targetId}`);
    if(!li)return;
    const progress=li.querySelector(".progress");
    const badge=li.querySelector(".badge");

    if(status==="processing"){
      progress.style.display="block";
      badge.textContent="processing";
      badge.className="badge bg-warning";
    }else{
      progress.style.display="none";
      badge.textContent=status;
      badge.className="badge bg-"+(status==="success"?"success":"danger");
    }
  });

  socket.on("campaign_done",()=>loadCampaigns());
  socket.on("campaign_stopped",()=>loadCampaigns());

  // create
  document.getElementById("campaignForm").addEventListener("submit",async e=>{
    e.preventDefault();
    const data={
      name:campaignName.value,
      templateId:templateId.value,
      sessionId:sessionId.value,
      numbers:numbers.value,
      speedMinMs:speedMinMs.value,
      speedMaxMs:speedMaxMs.value,
    };
    const res=await fetch("/campaigns/new",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});
    const json=await res.json();
    if(json.success){
      Swal.fire("Berhasil","Campaign dibuat","success");
      bootstrap.Modal.getInstance(document.getElementById("campaignModal"))?.hide();
      loadCampaigns();
    }
  });

  loadCampaigns();
});
</script>
