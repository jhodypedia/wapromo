<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <h4 class="mb-0"><i class="fa fa-bullhorn text-primary me-2"></i>Campaigns</h4>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#campaignModal">
    <i class="fa fa-plus me-2"></i>Campaign Baru
  </button>
</div>

<div class="table-responsive shadow-sm rounded">
  <table class="table table-hover align-middle mb-0">
    <thead class="table-light">
      <tr>
        <th style="width:50px">#</th>
        <th>Nama</th>
        <th>Template</th>
        <th>Status</th>
        <th>Target</th>
        <th style="width:140px">Aksi</th>
      </tr>
    </thead>
    <tbody id="campaignTableBody">
      <tr><td colspan="6" class="text-center text-muted">Loading...</td></tr>
    </tbody>
  </table>
</div>

<!-- Modal Detail Campaign -->
<div class="modal fade" id="campaignDetailModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title"><i class="fa fa-eye text-info me-2"></i>Detail Campaign</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="campaignDetailBody">
        <div class="text-muted">Loading...</div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Create Campaign -->
<div class="modal fade" id="campaignModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title"><i class="fa fa-plus text-primary me-2"></i>Buat Campaign Baru</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="createCampaignForm">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Nama Campaign</label>
            <input type="text" class="form-control" name="name" required placeholder="Promo Januari">
          </div>
          <div class="mb-3">
            <label class="form-label">Pilih Template</label>
            <select class="form-select" name="templateId" required>
              <option value="">-- Pilih Template --</option>
              <% templates.forEach(t=>{ %>
                <option value="<%= t.id %>"><%= t.name %></option>
              <% }) %>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Pilih Session</label>
            <select class="form-select" name="sessionId" required>
              <option value="">-- Pilih Session --</option>
              <% sessions.forEach(s=>{ %>
                <option value="<%= s.id %>"><%= s.label || s.sessionId %></option>
              <% }) %>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Daftar Nomor (1 per baris)</label>
            <textarea class="form-control" name="numbers" rows="5" required></textarea>
          </div>
          <div class="row">
            <div class="col">
              <label class="form-label">Min Delay (ms)</label>
              <input type="number" class="form-control" name="speedMinMs" value="5000">
            </div>
            <div class="col">
              <label class="form-label">Max Delay (ms)</label>
              <input type="number" class="form-control" name="speedMaxMs" value="15000">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="submit" class="btn btn-primary">
            <i class="fa fa-save me-1"></i>Simpan
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  .table td, .table th { vertical-align: middle; }
  .badge { font-size: .75rem; font-weight: 500; }
  .modal-body ul.list-group { max-height: 350px; overflow-y: auto; }
  .modal-body ul.list-group li { font-size: .85rem; }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const socket = window.io ? io() : null;
  toastr.options = { closeButton:true, progressBar:true, positionClass:"toast-top-right", timeOut:"3000" };

  // Load campaigns
  async function loadCampaigns() {
    try {
      const res = await fetch("/campaigns/list");
      const data = await res.json();
      const tbody = document.getElementById("campaignTableBody");
      tbody.innerHTML = "";
      if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Belum ada campaign</td></tr>';
        return;
      }
      data.forEach((c, i) => {
        const total = c.targets.length;
        const valid = c.targets.filter(t=>t.status==="valid").length;
        const invalid = c.targets.filter(t=>t.status==="invalid").length;
        const success = c.targets.filter(t=>t.status==="success").length;
        const error = c.targets.filter(t=>t.status==="error").length;

        tbody.innerHTML += `
          <tr id="campaign-row-${c.id}">
            <td>${i+1}</td>
            <td class="fw-semibold">${c.name}</td>
            <td>${c.template ? c.template.name : "-"}</td>
            <td id="status-${c.id}">
              <span class="badge rounded-pill bg-${c.status==="done"?"success":(c.status==="running"?"warning":"secondary")} px-3 py-2">${c.status}</span>
            </td>
            <td id="targets-${c.id}">
              <div class="d-flex flex-wrap gap-1 small">
                <span class="badge bg-info">T:${total}</span>
                <span class="badge bg-success">V:${valid}</span>
                <span class="badge bg-danger">I:${invalid}</span>
                <span class="badge bg-primary">S:${success}</span>
                <span class="badge bg-dark">E:${error}</span>
              </div>
            </td>
            <td class="d-flex gap-1" id="actions-${c.id}">
              ${c.status==="idle"
                ? `<button class="btn btn-sm btn-success run-campaign" data-id="${c.id}"><i class="fa fa-play"></i></button>`
                : (c.status==="running" ? `<button class="btn btn-sm btn-secondary" disabled><i class="fa fa-spinner fa-spin"></i></button>` : "")
              }
              <button class="btn btn-sm btn-info text-white detail-campaign" data-id="${c.id}"><i class="fa fa-eye"></i></button>
              <button class="btn btn-sm btn-danger delete-campaign" data-id="${c.id}"><i class="fa fa-trash"></i></button>
            </td>
          </tr>`;
      });
      bindActions();
    } catch (err) {
      toastr.error("Gagal memuat campaign");
    }
  }

  // Bind aksi run, delete, detail
  function bindActions() {
    document.querySelectorAll(".run-campaign").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.dataset.id;
        const res = await fetch(`/campaigns/${id}/run`, {method:"POST"});
        const json = await res.json();
        if (json.success) {
          toastr.success("Campaign dijalankan");
          loadCampaigns();
        } else {
          toastr.error(json.error || "Gagal menjalankan campaign");
        }
      });
    });

    document.querySelectorAll(".delete-campaign").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.dataset.id;
        const confirmDel = await Swal.fire({
          title:"Hapus Campaign?",
          text:"Data target juga akan terhapus.",
          icon:"warning",
          showCancelButton:true,
          confirmButtonText:"Ya, hapus",
          cancelButtonText:"Batal"
        });
        if (confirmDel.isConfirmed) {
          const res = await fetch(`/campaigns/${id}`, {method:"DELETE"});
          const json = await res.json();
          if (json.success) {
            toastr.success("Campaign dihapus");
            loadCampaigns();
          } else {
            toastr.error(json.error || "Gagal menghapus");
          }
        }
      });
    });

    document.querySelectorAll(".detail-campaign").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.dataset.id;
        const body = document.getElementById("campaignDetailBody");
        body.innerHTML = "<div class='text-muted'>Loading...</div>";
        new bootstrap.Modal(document.getElementById("campaignDetailModal")).show();
        const res = await fetch(`/campaigns/${id}/detail`);
        const json = await res.json();
        if (json.success) {
          const cp = json.campaign;
          body.innerHTML = `
            <h6 class="fw-bold">${cp.name}</h6>
            <p class="mb-1"><b>Status:</b> ${cp.status}</p>
            <p class="mb-2"><b>Template:</b> ${cp.template ? cp.template.name : "-"}</p>
            <hr>
            <h6 class="fw-bold">Target</h6>
            <ul class="list-group small" id="detail-targets-${cp.id}">
              ${cp.targets.map(t=>`<li class="list-group-item d-flex justify-content-between align-items-center">
                <span>${t.number}</span>
                <span class="badge bg-${t.status==="success"?"success":(t.status==="error"?"danger":(t.status==="valid"?"info":"secondary"))}">${t.status}</span>
              </li>`).join("")}
            </ul>`;
        } else {
          body.innerHTML = `<div class="text-danger">Gagal memuat detail: ${json.error}</div>`;
        }
      });
    });
  }

  // Create campaign
  const createForm = document.getElementById("createCampaignForm");
  if (createForm) {
    createForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const formData = new FormData(createForm);
      const payload = Object.fromEntries(formData.entries());
      try {
        const res = await fetch("/campaigns/new", {
          method:"POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        if (res.ok) {
          toastr.success("Campaign berhasil dibuat");
          bootstrap.Modal.getInstance(document.getElementById("campaignModal")).hide();
          createForm.reset();
          loadCampaigns();
        } else {
          toastr.error("Gagal membuat campaign");
        }
      } catch(err) {
        toastr.error("Server error saat membuat campaign");
      }
    });
  }

  // Real-time update dari socket
  if (socket) {
    socket.on("campaign_progress", ({ campaignId, number, status }) => {
      const row = document.getElementById(`campaign-row-${campaignId}`);
      if (row) {
        document.getElementById(`status-${campaignId}`).innerHTML =
          `<span class="badge rounded-pill bg-warning px-3 py-2">running</span>`;
      }
    });

    socket.on("campaign_done", ({ campaignId }) => {
      const row = document.getElementById(`campaign-row-${campaignId}`);
      if (row) {
        document.getElementById(`status-${campaignId}`).innerHTML =
          `<span class="badge rounded-pill bg-success px-3 py-2">done</span>`;
        document.getElementById(`actions-${campaignId}`).innerHTML = `
          <button class="btn btn-sm btn-info text-white detail-campaign" data-id="${campaignId}">
            <i class="fa fa-eye"></i>
          </button>
          <button class="btn btn-sm btn-danger delete-campaign" data-id="${campaignId}">
            <i class="fa fa-trash"></i>
          </button>`;
        bindActions();
      }
    });
  }

  loadCampaigns();
});
</script>
