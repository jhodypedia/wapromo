<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <h4 class="mb-0">
    <i class="fa-brands fa-whatsapp text-success me-2"></i>Koneksi WhatsApp
  </h4>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#sessionModal">
    <i class="fa fa-plus me-2"></i>Tambah / Pairing Session
  </button>
</div>

<div id="sessions" class="row g-3">
  <div class="col-12 text-muted">Memuat daftar session...</div>
</div>

<!-- Modal Input Session -->
<div class="modal fade" id="sessionModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title"><i class="fa fa-link text-primary me-2"></i>Kelola Session</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-pills mb-3">
          <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#newSessionPane" type="button">Tambah Session</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pairingPane" type="button">Pairing Code</button>
          </li>
        </ul>
        <div class="tab-content">
          <!-- Session Baru -->
          <div class="tab-pane fade show active" id="newSessionPane">
            <form id="newSessionForm">
              <div class="mb-3">
                <label class="form-label">Session ID</label>
                <input id="sessionId" class="form-control" placeholder="session-1" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Label</label>
                <input id="label" class="form-control" placeholder="Akun Toko #1">
              </div>
              <button class="btn btn-primary w-100"><i class="fa fa-play me-2"></i>Mulai</button>
            </form>
          </div>
          <!-- Pairing -->
          <div class="tab-pane fade" id="pairingPane">
            <form id="pairingForm">
              <div class="mb-3">
                <label class="form-label">Session ID</label>
                <input id="pairSession" class="form-control" placeholder="session-1" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Nomor WhatsApp (62...)</label>
                <input id="pairPhone" class="form-control" placeholder="628xxxx" required>
              </div>
              <button class="btn btn-outline-primary w-100"><i class="fa fa-link me-2"></i>Generate Code</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal QR/Pairing -->
<div class="modal fade" id="qrModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content glass">
      <div class="modal-header border-0">
        <h5 id="qrModalTitle" class="modal-title">Session</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <div id="qrContainer" class="my-3">
          <div class="text-muted">Menunggu QR / Pairing code...</div>
        </div>
        <div id="qrNote" class="small text-muted"></div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const socket = io();
  const container = document.getElementById("sessions");

  // ðŸ”¹ Render Card Session
  function renderSessionCard(s) {
    return `
      <div class="col-sm-6 col-md-4 col-lg-3 session-card" id="session-${s.sessionId}">
        <div class="card h-100 d-flex flex-column">
          <div class="card-body">
            <div class="fw-semibold">${s.label || s.sessionId}</div>
            <div class="small text-muted">ID: ${s.sessionId}</div>
            <span class="badge mt-2 bg-${
              s.status === "connected" ? "success" :
              s.status === "reconnecting" ? "warning" :
              "secondary"
            }">${s.status}</span>
          </div>
          <div class="card-footer d-flex justify-content-between">
            <button class="btn btn-sm btn-outline-primary open-session" data-session="${s.sessionId}">
              <i class="fa fa-qrcode me-1"></i>Buka
            </button>
            <button class="btn btn-sm btn-outline-danger delete-session" data-session="${s.sessionId}">
              <i class="fa fa-trash me-1"></i>Hapus
            </button>
          </div>
        </div>
      </div>`;
  }

  // ðŸ”¹ Load daftar session
  async function loadSessions() {
    try {
      const res = await fetch("/wa/connect/list");
      const sessions = await res.json();
      container.innerHTML = sessions.length
        ? sessions.map(s => renderSessionCard(s)).join("")
        : `<div class="col-12 text-muted">Belum ada session</div>`;
      bindActions();
    } catch (err) {
      Swal.fire("Error", "Gagal memuat session", "error");
    }
  }

  // ðŸ”¹ Bind aksi tombol
  function bindActions() {
    document.querySelectorAll(".open-session").forEach(btn => {
      btn.addEventListener("click", () => {
        const sessionId = btn.dataset.session;
        openQrModal(sessionId, "Menunggu QR / Pairing...");
      });
    });

    document.querySelectorAll(".delete-session").forEach(btn => {
      btn.addEventListener("click", async () => {
        const sessionId = btn.dataset.session;
        const confirm = await Swal.fire({
          title:"Hapus Session?",
          text:`Apakah yakin hapus ${sessionId}?`,
          icon:"warning",
          showCancelButton:true,
          confirmButtonText:"Ya, hapus",
          cancelButtonText:"Batal"
        });
        if (!confirm.isConfirmed) return;
        const res = await fetch(`/wa/${sessionId}`, {method:"DELETE"});
        const json = await res.json();
        if (json.success) {
          Swal.fire("Berhasil", `Session ${sessionId} dihapus`, "success");
          document.getElementById(`session-${sessionId}`)?.remove();
        } else {
          Swal.fire("Error", json.error || "Gagal hapus", "error");
        }
      });
    });
  }

  // ðŸ”¹ QR Modal
  function openQrModal(sessionId, msg="Loading...") {
    document.getElementById("qrModalTitle").innerText = `Session: ${sessionId}`;
    document.getElementById("qrContainer").innerHTML = `<div class="text-muted">${msg}</div>`;
    document.getElementById("qrNote").innerText = "";
    document.getElementById("qrModal").setAttribute("data-session", sessionId);
    new bootstrap.Modal(document.getElementById("qrModal")).show();
  }

  // ðŸ”¹ Form Session baru
  document.getElementById("newSessionForm")?.addEventListener("submit", async e => {
    e.preventDefault();
    const sessionId = document.getElementById("sessionId").value.trim();
    const label = document.getElementById("label").value.trim();
    bootstrap.Modal.getInstance(document.getElementById("sessionModal"))?.hide();
    openQrModal(sessionId, "Menunggu QR...");
    const res = await fetch("/wa/start", {
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ sessionId, label })
    });
    const json = await res.json();
    json.success ? Swal.fire("Berhasil", "Session dibuat", "success") : Swal.fire("Error", json.error, "error");
    loadSessions();
  });

  // ðŸ”¹ Form Pairing
  document.getElementById("pairingForm")?.addEventListener("submit", async e => {
    e.preventDefault();
    const sessionId = document.getElementById("pairSession").value.trim();
    const phone = document.getElementById("pairPhone").value.trim();
    bootstrap.Modal.getInstance(document.getElementById("sessionModal"))?.hide();
    openQrModal(sessionId, "Menunggu pairing code...");
    const res = await fetch("/wa/pairing", {
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ sessionId, phone })
    }).then(r=>r.json());
    if (res.success) {
      document.getElementById("qrContainer").innerHTML = `<div class="p-3 bg-light rounded fw-bold text-primary fs-4">${res.code}</div>`;
      document.getElementById("qrNote").innerText = "Masukkan kode di WhatsApp â†’ Perangkat Tertaut";
      Swal.fire("Berhasil", "Pairing code berhasil dibuat", "success");
    } else {
      Swal.fire("Error", res.error || "Gagal pairing", "error");
    }
  });

  // ðŸ”¹ Socket listener QR
  socket.on("wa_qr", ({ sessionId, qr }) => {
    const modal = document.getElementById("qrModal");
    if (modal.getAttribute("data-session") === sessionId) {
      const el = document.getElementById("qrContainer");
      el.innerHTML = "";
      new QRCode(el, { text: qr, width: 220, height: 220 });
      document.getElementById("qrNote").innerText = "Scan QR ini di WhatsApp â†’ Perangkat Tertaut";
    }
  });

  // ðŸ”¹ Socket listener status
  socket.on("wa_status", ({ sessionId, status }) => {
    loadSessions();
    if (status === "connected") Swal.fire("Connected", `Session ${sessionId} tersambung`, "success");
    if (status === "disconnected") Swal.fire("Disconnected", `Session ${sessionId} terputus`, "error");
  });

  // ðŸ”¹ Socket listener pairing code
  socket.on("wa_pairing", ({ sessionId, code }) => {
    const modal = document.getElementById("qrModal");
    if (modal.getAttribute("data-session") === sessionId) {
      document.getElementById("qrContainer").innerHTML = `
        <div class="p-3 bg-light rounded fw-bold text-primary fs-4">${code}</div>
      `;
      document.getElementById("qrNote").innerText = "Masukkan kode di WhatsApp â†’ Perangkat Tertaut";
    }
  });

  // ðŸ”¹ Load awal
  loadSessions();
});
</script>
