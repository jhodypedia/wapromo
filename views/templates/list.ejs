<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <h4 class="mb-0"><i class="fa fa-message text-primary me-2"></i>Template Pesan</h4>
  <button class="btn btn-primary" id="addTemplateBtn">
    <i class="fa fa-plus me-2"></i>Tambah Template
  </button>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <table id="templateTable" class="table align-middle w-100">
      <thead>
        <tr>
          <th>#</th>
          <th>Judul</th>
          <th>Isi</th>
          <th>Link</th>
          <th>Status</th>
          <th style="width:100px">Aksi</th>
        </tr>
      </thead>
      <tbody>
        <% templates.forEach((t, i) => { %>
          <tr data-id="<%= t.id %>">
            <td><%= i+1 %></td>
            <td><%= t.title %></td>
            <td style="white-space:pre-wrap"><%= t.body %></td>
            <td>
              <% if (t.link) { %>
                <a href="<%= t.link %>" target="_blank" class="text-decoration-none">
                  <i class="fa fa-link me-1"></i>Link
                </a>
              <% } else { %>-<% } %>
            </td>
            <td>
              <span class="badge <%= t.isActive ? 'bg-success' : 'bg-secondary' %>">
                <%= t.isActive ? 'Aktif' : 'Nonaktif' %>
              </span>
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-warning edit-template" title="Edit">
                  <i class="fa fa-pen"></i>
                </button>
                <button class="btn btn-outline-danger delete-template" title="Hapus">
                  <i class="fa fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal Form Create/Edit -->
<div class="modal fade" id="templateModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <form id="templateForm" class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="modalTitle">Tambah Template</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="templateId">
        <div class="mb-3">
          <label class="form-label">Judul</label>
          <input type="text" class="form-control" id="title" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Isi</label>
          <textarea class="form-control" id="body" rows="4" required></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Link (opsional)</label>
          <input type="url" class="form-control" id="link">
        </div>
        <div class="mb-3">
          <label class="form-label">Status</label>
          <select class="form-select" id="isActive">
            <option value="true">Aktif</option>
            <option value="false">Nonaktif</option>
          </select>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="submit" class="btn btn-primary">Simpan</button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Init DataTables
  const table = $('#templateTable').DataTable({
    responsive: true,
    pageLength: 5,
    language: {
      search: "Cari:",
      lengthMenu: "Tampilkan _MENU_ data",
      info: "Menampilkan _START_ - _END_ dari _TOTAL_ data",
      paginate: { previous: "‹", next: "›" },
      zeroRecords: "Tidak ada data ditemukan"
    }
  });

  const modal = new bootstrap.Modal(document.getElementById("templateModal"));
  const form = document.getElementById("templateForm");

  // Tambah Template
  document.getElementById("addTemplateBtn").addEventListener("click", () => {
    form.reset();
    document.getElementById("templateId").value = "";
    document.getElementById("modalTitle").innerText = "Tambah Template";
    modal.show();
  });

  // Submit Form (Tambah/Edit)
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const id = document.getElementById("templateId").value;
    const payload = {
      title: document.getElementById("title").value,
      body: document.getElementById("body").value,
      link: document.getElementById("link").value,
      isActive: document.getElementById("isActive").value
    };

    try {
      const res = await fetch(id ? `/templates/${id}` : "/templates", {
        method: id ? "PUT" : "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const json = await res.json();

      if (json.success) {
        Swal.fire("Berhasil", `Template ${id ? "diperbarui" : "ditambahkan"}`, "success");

        if (id) {
          // update row
          const row = $(`#templateTable tr[data-id="${id}"]`);
          row.find("td:eq(1)").text(json.template.title);
          row.find("td:eq(2)").text(json.template.body);
          row.find("td:eq(3)").html(json.template.link ? `<a href="${json.template.link}" target="_blank"><i class="fa fa-link me-1"></i>Link</a>` : "-");
          row.find("td:eq(4)").html(`<span class="badge ${json.template.isActive ? 'bg-success':'bg-secondary'}">${json.template.isActive ? 'Aktif':'Nonaktif'}</span>`);
        } else {
          // add new row
          const newRow = table.row.add([
            table.rows().count() + 1,
            json.template.title,
            json.template.body,
            json.template.link ? `<a href="${json.template.link}" target="_blank"><i class="fa fa-link me-1"></i>Link</a>` : "-",
            `<span class="badge ${json.template.isActive ? 'bg-success':'bg-secondary'}">${json.template.isActive ? 'Aktif':'Nonaktif'}</span>`,
            `<div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-outline-warning edit-template" title="Edit"><i class="fa fa-pen"></i></button>
              <button class="btn btn-outline-danger delete-template" title="Hapus"><i class="fa fa-trash"></i></button>
            </div>`
          ]).draw().node();
          $(newRow).attr("data-id", json.template.id);
        }

        modal.hide();
      } else {
        Swal.fire("Error", json.error || "Gagal simpan", "error");
      }
    } catch (err) {
      Swal.fire("Error", "Server error", "error");
    }
  });

  // Edit
  $('#templateTable').on('click', '.edit-template', function () {
    const tr = $(this).closest('tr');
    const id = tr.data('id');
    document.getElementById("templateId").value = id;
    document.getElementById("title").value = tr.children().eq(1).text();
    document.getElementById("body").value = tr.children().eq(2).text();
    document.getElementById("link").value = tr.children().eq(3).find("a").attr("href") || "";
    document.getElementById("isActive").value = tr.find("span.badge").text().trim() === "Aktif" ? "true" : "false";
    document.getElementById("modalTitle").innerText = "Edit Template";
    modal.show();
  });

  // Delete
  $('#templateTable').on('click', '.delete-template', async function () {
    const tr = $(this).closest('tr');
    const id = tr.data('id');

    const confirm = await Swal.fire({
      title: "Hapus Template?",
      text: "Data tidak bisa dikembalikan.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Ya, hapus",
      cancelButtonText: "Batal"
    });

    if (!confirm.isConfirmed) return;

    try {
      const res = await fetch(`/templates/${id}`, { method: "DELETE" });
      const json = await res.json();

      if (json.success) {
        Swal.fire("Berhasil", "Template dihapus", "success");
        table.row(tr).remove().draw();
      } else {
        Swal.fire("Error", json.error || "Gagal hapus", "error");
      }
    } catch (err) {
      Swal.fire("Error", "Server error", "error");
    }
  });
});
</script>
