<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0"><i class="fa fa-message text-primary me-2"></i>Template Pesan</h4>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">
    <i class="fa fa-plus me-2"></i>Tambah Template
  </button>
</div>

<div class="card p-3 shadow-sm">
  <div class="table-responsive">
    <table id="templateTable" class="table table-hover align-middle mb-0 nowrap" style="width:100%">
      <thead class="table-light">
        <tr>
          <th style="width:40px">#</th>
          <th>Judul</th>
          <th>Isi</th>
          <th>Link</th>
          <th>Status</th>
          <th style="width:120px">Aksi</th>
        </tr>
      </thead>
      <tbody>
        <% templates.forEach((t,i) => { %>
          <tr>
            <td><%= i+1 %></td>
            <td><%= t.title %></td>
            <td style="white-space:pre-wrap"><%= t.body %></td>
            <td>
              <% if (t.link) { %>
                <a href="<%= t.link %>" target="_blank" class="text-primary"><i class="fa fa-link me-1"></i>Link</a>
              <% } else { %>
                <span class="text-muted">-</span>
              <% } %>
            </td>
            <td>
              <span class="badge <%= t.isActive ? 'bg-success' : 'bg-secondary' %>">
                <%= t.isActive ? 'Aktif' : 'Nonaktif' %>
              </span>
            </td>
            <td class="d-flex gap-1">
              <button class="btn btn-sm btn-warning edit-template" data-id="<%= t.id %>">
                <i class="fa fa-pen"></i>
              </button>
              <button class="btn btn-sm btn-danger delete-template" data-id="<%= t.id %>">
                <i class="fa fa-trash"></i>
              </button>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal Tambah -->
<div class="modal fade" id="addModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title"><i class="fa fa-plus text-primary me-2"></i>Tambah Template</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form action="/templates/new" method="POST">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Judul</label>
            <input type="text" class="form-control" name="title" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Isi Pesan</label>
            <textarea class="form-control" name="body" rows="4" required></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Link (opsional)</label>
            <input type="url" class="form-control" name="link">
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="submit" class="btn btn-primary">Simpan</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Edit -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title"><i class="fa fa-pen text-warning me-2"></i>Edit Template</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="editForm">
        <div class="modal-body">
          <input type="hidden" id="editId">
          <div class="mb-3">
            <label class="form-label">Judul</label>
            <input type="text" class="form-control" id="editTitle" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Isi Pesan</label>
            <textarea class="form-control" id="editBody" rows="4" required></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Link</label>
            <input type="url" class="form-control" id="editLink">
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="editIsActive">
            <label class="form-check-label">Aktif</label>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="submit" class="btn btn-warning">Update</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
.table td, .table th { vertical-align: middle; }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Datatable
  $("#templateTable").DataTable({
    responsive: true,
    pageLength: 5,
    lengthMenu: [5, 10, 20],
    language: { url: "//cdn.datatables.net/plug-ins/1.13.7/i18n/id.json" }
  });

  // Edit
  document.querySelectorAll(".edit-template").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      const res = await fetch(`/templates/${id}`);
      const data = await res.json();

      if (data.success) {
        const tpl = data.data;
        document.getElementById("editId").value = tpl.id;
        document.getElementById("editTitle").value = tpl.title;
        document.getElementById("editBody").value = tpl.body;
        document.getElementById("editLink").value = tpl.link || "";
        document.getElementById("editIsActive").checked = tpl.isActive;

        new bootstrap.Modal(document.getElementById("editModal")).show();
      } else {
        Swal.fire("Error", "Template tidak ditemukan", "error");
      }
    });
  });

  // Submit Edit
  document.getElementById("editForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const id = document.getElementById("editId").value;
    const payload = {
      title: document.getElementById("editTitle").value,
      body: document.getElementById("editBody").value,
      link: document.getElementById("editLink").value,
      isActive: document.getElementById("editIsActive").checked
    };

    const res = await fetch(`/templates/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const json = await res.json();

    if (json.success) {
      Swal.fire("Berhasil", "Template berhasil diperbarui", "success")
        .then(() => location.reload());
    } else {
      Swal.fire("Error", json.error || "Gagal update", "error");
    }
  });

  // Delete
  document.querySelectorAll(".delete-template").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      const confirm = await Swal.fire({
        title: "Hapus Template?",
        text: "Tindakan ini tidak bisa dibatalkan",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Ya, hapus",
        cancelButtonText: "Batal"
      });

      if (confirm.isConfirmed) {
        const res = await fetch(`/templates/${id}`, { method: "DELETE" });
        const json = await res.json();

        if (json.success) {
          Swal.fire("Berhasil", "Template dihapus", "success")
            .then(() => location.reload());
        } else {
          Swal.fire("Error", json.error || "Gagal hapus", "error");
        }
      }
    });
  });
});
</script>
